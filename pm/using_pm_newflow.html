



<!DOCTYPE html>



<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using the BrainScaleS system &mdash; HBP Neuromorphic Computing Platform Guidebook (WIP)</title>
    
    <link rel="stylesheet" href="../_static/hbpdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2017-02-14 13:33:55 (4aeed78)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/extra.js"></script>
    <script type="text/javascript" src="../_static/hbpdoc.js"></script>
    <link rel="top" title="HBP Neuromorphic Computing Platform Guidebook (WIP)" href="../index.html" />
    <link rel="up" title="The BrainScaleS “physical model” system" href="pm.html" />
    <link rel="next" title="Simulating the BrainScaleS hardware" href="ess.html" />
    <link rel="prev" title="About the BrainScaleS hardware" href="pm_hardware_configuration.html" />
<meta name="viewport" content="width=device-width, initial-scale=1">

  </head>
  <body>
<div class="hbpdoc-page">
    <section class="hbpdoc-title page-header">
        <a class="project-title" href="../index.html">HBP Neuromorphic Computing Platform Guidebook</a>

        <a class="hbpdoc-toc-toggle pull-right" href>
            <span class="zmdi zmdi-menu"></span> <span class="sr-only icon-text">Menu</span>
        </a>
    </section>
    <section class="hbpdoc-main">
        <nav class="hbpdoc-sidebar hbpdoc-container">
            <a class="hbpdoc-toc-toggle pull-right" href>
                <span class="zmdi zmdi-menu"></span> <span class="sr-only icon-text">Menu</span>
            </a>
            
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/HBP_Primary_RGB_logoOnlyScaled68px.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using the BrainScaleS system</a><ul>
<li><a class="reference internal" href="#setup">Setup</a><ul>
<li><a class="reference internal" href="#ssh-agent">ssh-agent</a></li>
<li><a class="reference internal" href="#waf">waf</a></li>
<li><a class="reference internal" href="#pyhmf-marocco-and-dependencies">pyhmf, marocco and dependencies</a></li>
<li><a class="reference internal" href="#paths">paths</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-marocco">Using marocco</a><ul>
<li><a class="reference internal" href="#calibration">Calibration</a></li>
<li><a class="reference internal" href="#running-pynn-scripts">Running pyNN scripts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inspect-the-synapse-loss">Inspect the synapse loss</a></li>
<li><a class="reference internal" href="#details-of-the-software-stack">Details of the software stack</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="pm_hardware_configuration.html"
                        title="previous chapter">About the BrainScaleS hardware</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ess.html"
                        title="next chapter">Simulating the BrainScaleS hardware</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/pm/using_pm_newflow.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
        </nav>

        <article class="hbpdoc-content">

            <div class="content">
                
                <div class="breadcrumb breadcrumb-meta expand">
                    
                    <a href="pm.html">The BrainScaleS &#8220;physical model&#8221; system</a>
                    
                </div>
                

                <aside class="hbpdoc-hnav hbpdoc-hnav-top">
                    
                    <span class="hbpdoc-hnav-previous">
                        previous: <a class="hbpdoc-hnav-link" href="pm_hardware_configuration.html">About the BrainScaleS hardware</a>
                    </span>
                    
                    
                    <span class="hbpdoc-hnav-next">
                        next: <a class="hbpdoc-hnav-link" href="ess.html">Simulating the BrainScaleS hardware</a>
                    </span>
                    
                </aside>

                <div class="section" id="using-the-brainscales-system">
<h1>Using the BrainScaleS system<a class="headerlink" href="#using-the-brainscales-system" title="Permalink to this headline">¶</a></h1>
<p>As explained in <a class="reference internal" href="../building_models.html#building-models"><em>Building models</em></a>, both the experiment description and the model description
for the BrainScaleS system must be written as Python scripts,
using the PyNN application programming interface (API), version 0.7.</p>
<p>In the following, the build and work flow on UHEI BrainScaleS cluster frontend nodes is described.
If BrainScaleS is accessed through the Collaboratory or the Python client, the installation can be skipped.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>The following section can be skipped when loading the <tt class="docutils literal"><span class="pre">nmpm_software</span></tt> module by</p>
<div class="highlight-bash"><div class="highlight"><pre>module load nmpm_software/current-spack
</pre></div>
</div>
<p>All available versions can be listed by <tt class="docutils literal"><span class="pre">module</span> <span class="pre">avail</span> <span class="pre">nmpm_software</span></tt>.</p>
<p>To compile your own installation create and change to a directory for
your projects, preferably on <tt class="docutils literal"><span class="pre">wang</span></tt>, e.g.:
<tt class="docutils literal"><span class="pre">/wang/users/&lt;somebody&gt;/cluster_home/projects</span></tt>.</p>
<div class="section" id="ssh-agent">
<h3>ssh-agent<a class="headerlink" href="#ssh-agent" title="Permalink to this headline">¶</a></h3>
<p>To reduce the amount of typing, please consider using <tt class="docutils literal"><span class="pre">ssh-agent</span></tt> to cache your key password:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">eval</span> <span class="sb">`</span>ssh-agent<span class="sb">`</span>
ssh-add ~/path/to/your/private_id_rsa
</pre></div>
</div>
</div>
<div class="section" id="waf">
<h3>waf<a class="headerlink" href="#waf" title="Permalink to this headline">¶</a></h3>
<p>This step is optional as there exists a <tt class="docutils literal"><span class="pre">waf</span></tt> module.
However, if you need a customized waf version:</p>
<div class="highlight-bash"><div class="highlight"><pre>git clone git@gitviz.kip.uni-heidelberg.de:waf.git -b symwaf2ic visions-waf
make -f visions-waf/Makefile
ln -f visions-waf/waf .
<span class="nb">alias </span><span class="nv">waf</span><span class="o">=</span><span class="nv">$PWD</span>/waf
</pre></div>
</div>
</div>
<div class="section" id="pyhmf-marocco-and-dependencies">
<h3>pyhmf, marocco and dependencies<a class="headerlink" href="#pyhmf-marocco-and-dependencies" title="Permalink to this headline">¶</a></h3>
<p>Then create and change to a directory for marocco, e.g., <tt class="docutils literal"><span class="pre">/wang/users/somebody/cluster_home/projects/marocco</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">source</span> /wang/environment/software/<span class="k">$(</span>lsb_release -c -s<span class="k">)</span>/spack/share/spack/setup-env.sh
spack load --dependencies gcc@4.9.2
spack load --dependencies visionary-defaults
module load waf

waf setup --project pyhmf --project<span class="o">=</span>marocco --without-ester
waf configure
waf install --test-execnone
<span class="c"># some extra targets are needed</span>
waf install --target<span class="o">=</span>pymarocco,pyhalbe,pysthal,redman_xml --test-execnone
</pre></div>
</div>
<p>including cake (optional):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">source</span> /wang/environment/software/<span class="k">$(</span>lsb_release -c -s<span class="k">)</span>/spack/share/spack/setup-env.sh
spack load --dependencies gcc@4.9.2
spack load --dependencies visionary-defaults
module load waf

waf setup --project pyhmf --project marocco --project cake --without-ester
waf configure
waf install --test-execnone
<span class="c"># some extra targets are needed</span>
waf install --target<span class="o">=</span>pymarocco,pyhalbe,pysthal,redman_xml,pycake --test-execnone
</pre></div>
</div>
<p>including support for ESS add <tt class="docutils literal"><span class="pre">--with-ess</span></tt> to setup call.</p>
</div>
<div class="section" id="paths">
<h3>paths<a class="headerlink" href="#paths" title="Permalink to this headline">¶</a></h3>
<p>To include the local paths in your environment, please use:</p>
<div class="highlight-bash"><div class="highlight"><pre>module load localdir
</pre></div>
</div>
<p>Another method would be to create an init file and put all the needed parts into a script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">echo</span> <span class="s2">&quot;INSTALLED_LIB_PATH=$(readlink -e lib)&quot;</span> &gt; init.sh
cat &gt;&gt;init.sh<span class="s">&lt;&lt;EOF</span>
<span class="s">source /wang/environment/software/$(lsb_release -c -s)/spack/share/spack/setup-env.sh</span>
<span class="s">spack load --dependencies gcc@4.9.2</span>
<span class="s">spack load --dependencies visionary-defaults</span>
<span class="s">module load localdir</span>
<span class="s">module load waf</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>In every (!) fresh shell you now have to source the <tt class="docutils literal"><span class="pre">init.sh</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">source </span>path/to/init.sh
</pre></div>
</div>
<p>Check if the installation and the setup of variables is fine:</p>
<div class="highlight-bash"><div class="highlight"><pre>python -c <span class="s2">&quot;import pyhmf&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">echo </span>ok
</pre></div>
</div>
<p>should print <tt class="docutils literal"><span class="pre">ok</span></tt>, if instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#import pyNN.nest as pynn  # if you want to use the NEST simulator</span>
<span class="kn">import</span> <span class="nn">pyhmf</span> <span class="kn">as</span> <span class="nn">pynn</span>       <span class="c"># if you want to use the BrainScaleS Wafer-Scale System</span>
</pre></div>
</div>
<p>The translation from the <cite>biological</cite> neuronal network description into a <cite>hardware</cite> configuration
is performed by the <tt class="docutils literal"><span class="pre">marocco</span></tt> mapping tool
(for more detailed information, see <a class="reference internal" href="#details-software-stack"><em>Details of the software stack</em></a> below).</p>
<p>The BrainScaleS system attempts to automatically place neurons on the wafers in an optimal way.
However, it is possible to influence this placement, control it manually, and examine the resultant
data structures using the Python helper module <tt class="xref py py-mod docutils literal"><span class="pre">pymarocco</span></tt>.
This enables users to go from a property in PyNN (e.g. the refractory period of a single neuron
within an assembly) to the corresponding parameter on hardware.
A typical use case is iterative low-level tuning of hardware parameters.</p>
</div>
</div>
<div class="section" id="using-marocco">
<span id="label-marocco-example"></span><h2>Using marocco<a class="headerlink" href="#using-marocco" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pyhmf</span> <span class="kn">as</span> <span class="nn">pynn</span>
<span class="kn">from</span> <span class="nn">pymarocco</span> <span class="kn">import</span> <span class="n">PyMarocco</span>

<span class="n">marocco</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="p">()</span>
<span class="n">pynn</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">marocco</span><span class="o">=</span><span class="n">marocco</span><span class="p">)</span>
</pre></div>
</div>
<p>Make sure that the call to <tt class="xref py py-func docutils literal"><span class="pre">setup()</span></tt> happens before creating
populations, if not, the populations will not be visible to <tt class="docutils literal"><span class="pre">marocco</span></tt>.</p>
<p>In the following example, one neuron is placed on the wafer, however,
by setting <tt class="docutils literal"><span class="pre">marocco.backend</span> <span class="pre">=</span> <span class="pre">PyMarocco.None</span></tt>, the software stops after the map &amp; route process
(i.e. before configuring the hardware system).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pyhmf</span> <span class="kn">as</span> <span class="nn">pynn</span>
<span class="kn">from</span> <span class="nn">pymarocco</span> <span class="kn">import</span> <span class="n">PyMarocco</span>

<span class="n">marocco</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="p">()</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="o">.</span><span class="n">None</span>

<span class="n">pynn</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">marocco</span><span class="o">=</span><span class="n">marocco</span><span class="p">)</span>

<span class="n">neuron</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pynn</span><span class="o">.</span><span class="n">IF_cond_exp</span><span class="p">,</span> <span class="p">{})</span>

<span class="n">pynn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">pynn</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Available <tt class="docutils literal"><span class="pre">marocco</span></tt> backends are <tt class="docutils literal"><span class="pre">None</span></tt>, <tt class="docutils literal"><span class="pre">Hardware</span></tt>, <tt class="docutils literal"><span class="pre">ESS</span></tt>. None has been described above.
Hardware is the default and performs real experiment runs on the neuromorphic hardware system.
ESS runs a simulation of the hardware: the Executable System Specification.</p>
</div>
<p>In the output you should see:</p>
<div class="highlight-bash"><div class="highlight"><pre>Populations:
        0th element:    0x1f98650       Population<span class="o">(</span>IF_cond_exp, 1<span class="o">)</span>
</pre></div>
</div>
<p>If you don&#8217;t see this output, make sure that you called
<tt class="docutils literal"><span class="pre">pynn.setup(marocco=marocco)</span></tt> before the call to <tt class="docutils literal"><span class="pre">pynn.Population</span></tt>.</p>
<p>You will also see a lot of debugging output. To set the log level, add</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pylogging</span>
<span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">]:</span>
    <span class="n">pylogging</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="n">pylogging</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">domain</span><span class="p">),</span> <span class="n">pylogging</span><span class="o">.</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</pre></div>
</div>
<p>after the import of <tt class="xref py py-mod docutils literal"><span class="pre">pymarocco</span></tt>.</p>
<p>As we did not specify on which chip the neuron should be placed,
marocco decides automatically to use <tt class="docutils literal"><span class="pre">HICANNOnWafer(X(18),</span> <span class="pre">Y(7)),</span>
<span class="pre">Wafer(0)</span></tt> which is in the center of the wafer.</p>
<p>To choose the HICANN a population is placed on, we give marocco a hint:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">Coordinate</span> <span class="kn">as</span> <span class="nn">C</span>

<span class="n">marocco</span><span class="o">.</span><span class="n">manual_placement</span><span class="o">.</span><span class="n">on_hicann</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">HICANNOnWafer</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
</pre></div>
</div>
<p>At the end, the script is the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">pyhmf</span> <span class="kn">as</span> <span class="nn">pynn</span>
<span class="kn">import</span> <span class="nn">Coordinate</span> <span class="kn">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">pymarocco</span> <span class="kn">import</span> <span class="n">PyMarocco</span>
<span class="kn">from</span> <span class="nn">pymarocco.results</span> <span class="kn">import</span> <span class="n">Marocco</span>

<span class="kn">import</span> <span class="nn">pylogging</span>
<span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;Calibtic&quot;</span><span class="p">,</span> <span class="s">&quot;marocco&quot;</span><span class="p">]:</span>
    <span class="n">pylogging</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="n">pylogging</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">domain</span><span class="p">),</span> <span class="n">pylogging</span><span class="o">.</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">marocco</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="p">()</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">persist</span> <span class="o">=</span> <span class="s">&quot;results.bin&quot;</span>
<span class="n">pynn</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">marocco</span> <span class="o">=</span> <span class="n">marocco</span><span class="p">)</span>

<span class="n">pop</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pynn</span><span class="o">.</span><span class="n">IF_cond_exp</span><span class="p">)</span>

<span class="n">marocco</span><span class="o">.</span><span class="n">manual_placement</span><span class="o">.</span><span class="n">on_hicann</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">HICANNOnWafer</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="mi">5</span><span class="p">)),</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">pynn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">pynn</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">Marocco</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">marocco</span><span class="o">.</span><span class="n">persist</span><span class="p">)</span>

<span class="k">for</span> <span class="n">neuron</span> <span class="ow">in</span> <span class="n">pop</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">placement</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">neuron</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">denmem</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">logical_neuron</span><span class="p">():</span>
            <span class="k">print</span> <span class="n">denmem</span>
</pre></div>
</div>
<p>We also added a print out of the chosen neuron circuits:</p>
<div class="highlight-bash"><div class="highlight"><pre>NeuronOnWafer<span class="o">(</span>NeuronOnHICANN<span class="o">(</span>X<span class="o">(</span>0<span class="o">)</span>, top<span class="o">)</span>, HICANNOnWafer<span class="o">(</span>X<span class="o">(</span>5<span class="o">)</span>, Y<span class="o">(</span>5<span class="o">)))</span>
NeuronOnWafer<span class="o">(</span>NeuronOnHICANN<span class="o">(</span>X<span class="o">(</span>1<span class="o">)</span>, top<span class="o">)</span>, HICANNOnWafer<span class="o">(</span>X<span class="o">(</span>5<span class="o">)</span>, Y<span class="o">(</span>5<span class="o">)))</span>
NeuronOnWafer<span class="o">(</span>NeuronOnHICANN<span class="o">(</span>X<span class="o">(</span>0<span class="o">)</span>, bottom<span class="o">)</span>, HICANNOnWafer<span class="o">(</span>X<span class="o">(</span>5<span class="o">)</span>, Y<span class="o">(</span>5<span class="o">)))</span>
NeuronOnWafer<span class="o">(</span>NeuronOnHICANN<span class="o">(</span>X<span class="o">(</span>1<span class="o">)</span>, bottom<span class="o">)</span>, HICANNOnWafer<span class="o">(</span>X<span class="o">(</span>5<span class="o">)</span>, Y<span class="o">(</span>5<span class="o">)))</span>
</pre></div>
</div>
<div class="section" id="calibration">
<h3>Calibration<a class="headerlink" href="#calibration" title="Permalink to this headline">¶</a></h3>
<p>To change the calibration backend from database to XML set
&#8220;calib_backend&#8221; to XML. Then the calibration is looked up in xml files
named <tt class="docutils literal"><span class="pre">w0-h84.xml</span></tt>, <tt class="docutils literal"><span class="pre">w0-h276.xml</span></tt>, etc. in the directory
&#8220;calib_path&#8221;.</p>
</div>
<div class="section" id="running-pynn-scripts">
<span id="id1"></span><h3>Running pyNN scripts<a class="headerlink" href="#running-pynn-scripts" title="Permalink to this headline">¶</a></h3>
<p>To run on the <em>hardware</em> one needs to use the slurm job queue system:</p>
<div class="highlight-bash"><div class="highlight"><pre>srun -p experiment --wmod 33 --hicann 367 python nmpm1_single_neuron.py
</pre></div>
</div>
<p>nmpm1_single_neuron.py:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8; -*-</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pyhalbe</span> <span class="kn">import</span> <span class="n">HICANN</span>
<span class="kn">import</span> <span class="nn">pyhalbe.Coordinate</span> <span class="kn">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">pysthal.command_line_util</span> <span class="kn">import</span> <span class="n">init_logger</span>

<span class="kn">import</span> <span class="nn">pyhmf</span> <span class="kn">as</span> <span class="nn">pynn</span>
<span class="kn">from</span> <span class="nn">pymarocco</span> <span class="kn">import</span> <span class="n">PyMarocco</span><span class="p">,</span> <span class="n">Defects</span>
<span class="kn">from</span> <span class="nn">pymarocco.runtime</span> <span class="kn">import</span> <span class="n">Runtime</span>
<span class="kn">from</span> <span class="nn">pymarocco.coordinates</span> <span class="kn">import</span> <span class="n">LogicalNeuron</span>
<span class="kn">from</span> <span class="nn">pymarocco.results</span> <span class="kn">import</span> <span class="n">Marocco</span>

<span class="n">init_logger</span><span class="p">(</span><span class="s">&quot;WARN&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">&quot;guidebook&quot;</span><span class="p">,</span> <span class="s">&quot;DEBUG&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&quot;marocco&quot;</span><span class="p">,</span> <span class="s">&quot;DEBUG&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&quot;Calibtic&quot;</span><span class="p">,</span> <span class="s">&quot;DEBUG&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&quot;sthal&quot;</span><span class="p">,</span> <span class="s">&quot;INFO&quot;</span><span class="p">)</span>
<span class="p">])</span>

<span class="kn">import</span> <span class="nn">pylogging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">pylogging</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;guidebook&quot;</span><span class="p">)</span>

<span class="n">neuron_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;cm&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="s">&#39;v_reset&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">70.</span><span class="p">,</span>
    <span class="s">&#39;v_rest&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">20.</span><span class="p">,</span>
    <span class="s">&#39;v_thresh&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span>
    <span class="s">&#39;e_rev_I&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">100.</span><span class="p">,</span>
    <span class="s">&#39;e_rev_E&#39;</span><span class="p">:</span> <span class="mf">60.</span><span class="p">,</span>
    <span class="s">&#39;tau_m&#39;</span><span class="p">:</span> <span class="mf">20.</span><span class="p">,</span>
    <span class="s">&#39;tau_refrac&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s">&#39;tau_syn_E&#39;</span><span class="p">:</span> <span class="mf">5.</span><span class="p">,</span>
    <span class="s">&#39;tau_syn_I&#39;</span><span class="p">:</span> <span class="mf">5.</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">marocco</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="p">()</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">neuron_placement</span><span class="o">.</span><span class="n">default_neuron_size</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">neuron_placement</span><span class="o">.</span><span class="n">minimize_number_of_sending_repeaters</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">merger_routing</span><span class="o">.</span><span class="n">strategy</span><span class="p">(</span><span class="n">marocco</span><span class="o">.</span><span class="n">merger_routing</span><span class="o">.</span><span class="n">one_to_one</span><span class="p">)</span>

<span class="n">marocco</span><span class="o">.</span><span class="n">bkg_gen_isi</span> <span class="o">=</span> <span class="mi">125</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">pll_freq</span> <span class="o">=</span> <span class="mf">125e6</span>

<span class="n">marocco</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="o">.</span><span class="n">Hardware</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">calib_backend</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="o">.</span><span class="n">XML</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">marocco</span><span class="o">.</span><span class="n">calib_path</span> <span class="o">=</span> <span class="s">&quot;/wang/data/calibration/ITL_2016&quot;</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">XML</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">default_wafer</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">Wafer</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">param_trafo</span><span class="o">.</span><span class="n">use_big_capacitors</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">input_placement</span><span class="o">.</span><span class="n">consider_firing_rate</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">input_placement</span><span class="o">.</span><span class="n">bandwidth_utilization</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="p">(</span><span class="n">marocco</span><span class="o">.</span><span class="n">default_wafer</span><span class="p">)</span>
<span class="n">pynn</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">marocco</span><span class="o">=</span><span class="n">marocco</span><span class="p">,</span> <span class="n">marocco_runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>

<span class="c">#  ——— set up network ——————————————————————————————————————————————————————————</span>

<span class="n">pop</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pynn</span><span class="o">.</span><span class="n">IF_cond_exp</span><span class="p">,</span> <span class="n">neuron_parameters</span><span class="p">)</span>

<span class="n">pop</span><span class="o">.</span><span class="n">record</span><span class="p">()</span>
<span class="n">pop</span><span class="o">.</span><span class="n">record_v</span><span class="p">()</span>

<span class="n">hicann</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">HICANNOnWafer</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mi">367</span><span class="p">))</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">manual_placement</span><span class="o">.</span><span class="n">on_hicann</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="n">hicann</span><span class="p">)</span>

<span class="n">connector</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">AllToAllConnector</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">exc_spike_times</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">250</span><span class="p">,</span>
    <span class="mi">500</span><span class="p">,</span>
    <span class="mi">520</span><span class="p">,</span>
    <span class="mi">540</span><span class="p">,</span>
    <span class="mi">1250</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">inh_spike_times</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">750</span><span class="p">,</span>
    <span class="mi">1000</span><span class="p">,</span>
    <span class="mi">1020</span><span class="p">,</span>
    <span class="mi">1040</span><span class="p">,</span>
    <span class="mi">1250</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">duration</span> <span class="o">=</span> <span class="mf">1500.0</span>

<span class="n">stimulus_exc</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pynn</span><span class="o">.</span><span class="n">SpikeSourceArray</span><span class="p">,</span> <span class="p">{</span>
    <span class="s">&#39;spike_times&#39;</span><span class="p">:</span> <span class="n">exc_spike_times</span><span class="p">})</span>
<span class="n">stimulus_inh</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pynn</span><span class="o">.</span><span class="n">SpikeSourceArray</span><span class="p">,</span> <span class="p">{</span>
    <span class="s">&#39;spike_times&#39;</span><span class="p">:</span> <span class="n">inh_spike_times</span><span class="p">})</span>

<span class="n">projections</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pynn</span><span class="o">.</span><span class="n">Projection</span><span class="p">(</span><span class="n">stimulus_exc</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;excitatory&#39;</span><span class="p">),</span>
    <span class="n">pynn</span><span class="o">.</span><span class="n">Projection</span><span class="p">(</span><span class="n">stimulus_inh</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;inhibitory&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c">#  ——— run mapping —————————————————————————————————————————————————————————————</span>

<span class="n">marocco</span><span class="o">.</span><span class="n">skip_mapping</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="o">.</span><span class="n">None</span>

<span class="n">pynn</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">pynn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>

<span class="c">#  ——— change low-level parameters before configuring hardware —————————————————</span>

<span class="k">def</span> <span class="nf">set_sthal_params</span><span class="p">(</span><span class="n">wafer</span><span class="p">,</span> <span class="n">gmax</span><span class="p">,</span> <span class="n">gmax_div</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">hicann</span> <span class="ow">in</span> <span class="n">wafer</span><span class="o">.</span><span class="n">getAllocatedHicannCoordinates</span><span class="p">():</span>
        <span class="n">fgs</span> <span class="o">=</span> <span class="n">wafer</span><span class="p">[</span><span class="n">hicann</span><span class="p">]</span><span class="o">.</span><span class="n">floating_gates</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">fgs</span><span class="o">.</span><span class="n">getNoProgrammingPasses</span><span class="p">()):</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">fgs</span><span class="o">.</span><span class="n">getFGConfig</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">fg_biasn</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">fg_bias</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fgs</span><span class="o">.</span><span class="n">setFGConfig</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="n">cfg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">iter_all</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">FGBlockOnHICANN</span><span class="p">):</span>
            <span class="n">fgs</span><span class="o">.</span><span class="n">setShared</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">HICANN</span><span class="o">.</span><span class="n">shared_parameter</span><span class="o">.</span><span class="n">V_gmax0</span><span class="p">,</span> <span class="n">gmax</span><span class="p">)</span>
            <span class="n">fgs</span><span class="o">.</span><span class="n">setShared</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">HICANN</span><span class="o">.</span><span class="n">shared_parameter</span><span class="o">.</span><span class="n">V_gmax1</span><span class="p">,</span> <span class="n">gmax</span><span class="p">)</span>
            <span class="n">fgs</span><span class="o">.</span><span class="n">setShared</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">HICANN</span><span class="o">.</span><span class="n">shared_parameter</span><span class="o">.</span><span class="n">V_gmax2</span><span class="p">,</span> <span class="n">gmax</span><span class="p">)</span>
            <span class="n">fgs</span><span class="o">.</span><span class="n">setShared</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">HICANN</span><span class="o">.</span><span class="n">shared_parameter</span><span class="o">.</span><span class="n">V_gmax3</span><span class="p">,</span> <span class="n">gmax</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">iter_all</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">FGBlockOnHICANN</span><span class="p">):</span>
            <span class="n">fgs</span><span class="o">.</span><span class="n">setShared</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">HICANN</span><span class="o">.</span><span class="n">shared_parameter</span><span class="o">.</span><span class="n">V_dllres</span><span class="p">,</span> <span class="mi">275</span><span class="p">)</span>
            <span class="n">fgs</span><span class="o">.</span><span class="n">setShared</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">HICANN</span><span class="o">.</span><span class="n">shared_parameter</span><span class="o">.</span><span class="n">V_ccas</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">iter_all</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">SynapseDriverOnHICANN</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">iter_all</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">RowOnSynapseDriver</span><span class="p">):</span>
                <span class="n">wafer</span><span class="p">[</span><span class="n">hicann</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">set_gmax_div</span><span class="p">(</span>
                    <span class="n">C</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">gmax_div</span><span class="p">)</span>
                <span class="n">wafer</span><span class="p">[</span><span class="n">hicann</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">set_gmax_div</span><span class="p">(</span>
                    <span class="n">C</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">gmax_div</span><span class="p">)</span>

<span class="n">set_sthal_params</span><span class="p">(</span><span class="n">runtime</span><span class="o">.</span><span class="n">wafer</span><span class="p">(),</span> <span class="n">gmax</span><span class="o">=</span><span class="mi">1023</span><span class="p">,</span> <span class="n">gmax_div</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c">#  ——— configure hardware ——————————————————————————————————————————————————————</span>

<span class="n">marocco</span><span class="o">.</span><span class="n">skip_mapping</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="o">.</span><span class="n">Hardware</span>
<span class="c"># Full configuration during first step</span>
<span class="n">marocco</span><span class="o">.</span><span class="n">hicann_configurator</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="o">.</span><span class="n">HICANNv4Configurator</span>

<span class="k">for</span> <span class="n">digital_weight</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">]:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;running measurement with digital weight {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digital_weight</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">projections</span><span class="p">:</span>
        <span class="n">proj_item</span><span class="p">,</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">results</span><span class="p">()</span><span class="o">.</span><span class="n">synapse_routing</span><span class="o">.</span><span class="n">synapses</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
        <span class="n">synapse</span> <span class="o">=</span> <span class="n">proj_item</span><span class="o">.</span><span class="n">hardware_synapse</span><span class="p">()</span>

        <span class="n">proxy</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">wafer</span><span class="p">()[</span><span class="n">synapse</span><span class="o">.</span><span class="n">toHICANNOnWafer</span><span class="p">()]</span><span class="o">.</span><span class="n">synapses</span><span class="p">[</span><span class="n">synapse</span><span class="p">]</span>
        <span class="n">proxy</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">HICANN</span><span class="o">.</span><span class="n">SynapseWeight</span><span class="p">(</span><span class="n">digital_weight</span><span class="p">)</span>

    <span class="n">pynn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s">&quot;membrane_w{}.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digital_weight</span><span class="p">),</span> <span class="n">pop</span><span class="o">.</span><span class="n">get_v</span><span class="p">())</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s">&quot;spikes_w{}.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digital_weight</span><span class="p">),</span> <span class="n">pop</span><span class="o">.</span><span class="n">getSpikes</span><span class="p">())</span>
    <span class="n">pynn</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c"># only change digital parameters from now on</span>
    <span class="n">marocco</span><span class="o">.</span><span class="n">hicann_configurator</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="o">.</span><span class="n">NoResetNoFGConfigurator</span>
</pre></div>
</div>
<p>Currently, the calibration is optimized towards the neuron parameters of the example.
Also note that current parameters, i.e. <tt class="docutils literal"><span class="pre">i_offset</span></tt> are not supported.</p>
<p>With the help of <tt class="docutils literal"><span class="pre">plot_spikes.py</span></tt>, the recorded spikes (<tt class="docutils literal"><span class="pre">spikes_w15.txt</span></tt>) and
membrane trace (<tt class="docutils literal"><span class="pre">membrane_w15.txt</span></tt>) for the digital weight setting 15 can be plotted.</p>
<div class="figure">
<img alt="Membrane trace and spikes for digital weight 15" src="../_images/example_plot_w15.png" />
</div>
</div>
</div>
<div class="section" id="inspect-the-synapse-loss">
<h2>Inspect the synapse loss<a class="headerlink" href="#inspect-the-synapse-loss" title="Permalink to this headline">¶</a></h2>
<p>When mapping network models to the wafer-scale hardware, it may happen that not
all model synapses can be realized on the hardware due to limited hardware
resources. Below is a simple network that is mapped to very limited resources
so that synapse loss is enforced. For this example we show how to extract
overall mapping statistics and projection-wise or synapse-wise synapse losses.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create small network with synapse loss.  The synapse loss happens due to a</span>
<span class="sd">    maximum syndriver chain length of 5 and only 4 denmems per neuron.  After</span>
<span class="sd">    mapping, the synapse loss per projection is evaluated and plotted for one</span>
<span class="sd">    projection.  The sum of lost synapses per projection is compared to the</span>
<span class="sd">    overall synapse loss returnd by the mapping stats.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">marocco</span> <span class="o">=</span> <span class="n">PyMarocco</span><span class="p">()</span>
    <span class="n">marocco</span><span class="o">.</span><span class="n">neuron_placement</span><span class="o">.</span><span class="n">default_neuron_size</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">marocco</span><span class="o">.</span><span class="n">synapse_routing</span><span class="o">.</span><span class="n">driver_chain_length</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">pynn</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">marocco</span><span class="o">=</span><span class="n">marocco</span><span class="p">)</span>

    <span class="n">neuron</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">pynn</span><span class="o">.</span><span class="n">IF_cond_exp</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">pynn</span><span class="o">.</span><span class="n">SpikeSourcePoisson</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;rate&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

    <span class="n">connector</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">FixedProbabilityConnector</span><span class="p">(</span>
            <span class="n">allow_self_connections</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">p_connect</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="mf">0.00425</span><span class="p">)</span>
    <span class="n">proj_stim</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Projection</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">neuron</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&quot;excitatory&quot;</span><span class="p">)</span>
    <span class="n">proj_rec</span> <span class="o">=</span> <span class="n">pynn</span><span class="o">.</span><span class="n">Projection</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">neuron</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&quot;excitatory&quot;</span><span class="p">)</span>

    <span class="n">pynn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">marocco</span><span class="o">.</span><span class="n">stats</span>

    <span class="n">total_syns</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lost_syns</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">proj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">proj_stim</span><span class="p">,</span> <span class="n">proj_rec</span><span class="p">]:</span>
        <span class="n">l</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">projectionwise_synapse_loss</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">marocco</span><span class="p">)</span>
        <span class="n">total_syns</span> <span class="o">+=</span> <span class="n">t</span>
        <span class="n">lost_syns</span> <span class="o">+=</span> <span class="n">l</span>

    <span class="k">assert</span> <span class="n">total_syns</span> <span class="o">==</span> <span class="n">marocco</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">getSynapses</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">lost_syns</span> <span class="o">==</span> <span class="n">marocco</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">getSynapseLoss</span><span class="p">()</span>

    <span class="n">plot_projectionwise_synapse_loss</span><span class="p">(</span><span class="n">proj_stim</span><span class="p">,</span> <span class="n">marocco</span><span class="p">)</span>
    <span class="n">pynn</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
</pre></div>
</div>
<p>Where <tt class="docutils literal"><span class="pre">print</span> <span class="pre">marocco.stats</span></tt> prints out overall synapse loss statistics:</p>
<div class="highlight-bash"><div class="highlight"><pre>MappingStats <span class="o">{</span>
        synapse_loss: 581 <span class="o">(</span>23.3709%<span class="o">)</span>
        synapses: 2486
        synapses <span class="nb">set</span>: 1905
        synapses lost: 581
        synapses lost<span class="o">(</span>l1<span class="o">)</span>: 0
        populations: 2
        projections: 2
        neurons: 50<span class="o">}</span>
</pre></div>
</div>
<p>Invidual mapping statistics like the number of synapses set can also be
directly accessed in python, see class <tt class="docutils literal"><span class="pre">MappingStats</span></tt> in the
<a class="reference external" href="https://brainscales-r.kip.uni-heidelberg.de:8443/view/doc/job/doc-dsl_marocco/marocco_Documentation">marocco documentation</a>.</p>
<p>The function <tt class="docutils literal"><span class="pre">projectionwise_synapse_loss</span></tt> shows how to calculate the synapse
loss per projection.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">projectionwise_synapse_loss</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">marocco</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    computes the synapse loss of a projection</span>
<span class="sd">    params:</span>
<span class="sd">      proj    - a pyhmf.Projection</span>
<span class="sd">      marocco -  the PyMarocco object after the mapping has run.</span>

<span class="sd">    returns: (nr of lost synapses, total synapses in projection)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_weights</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">getWeights</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;array&#39;</span><span class="p">)</span>
    <span class="n">mapped_weights</span> <span class="o">=</span> <span class="n">marocco</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">getWeights</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
    <span class="n">syns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">orig_weights</span><span class="p">))</span>
    <span class="n">realized_syns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mapped_weights</span><span class="p">))</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">realized</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">realized_syns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">print</span> <span class="s">&quot;Projection-Wise Synapse Loss&quot;</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="p">(</span><span class="n">orig</span> <span class="o">-</span> <span class="n">realized</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span><span class="o">/</span><span class="n">orig</span>
    <span class="k">return</span> <span class="n">orig</span><span class="o">-</span><span class="n">realized</span><span class="p">,</span> <span class="n">orig</span>
</pre></div>
</div>
<p>Which yields the following output for the example above:</p>
<div class="highlight-bash"><div class="highlight"><pre>Projection-Wise Synapse Loss Projection <span class="o">(</span> PyAssembly <span class="o">(</span>50<span class="o">)</span> -&gt; PyAssembly <span class="o">(</span>50<span class="o">))</span> 23.5576923077
Projection-Wise Synapse Loss Projection <span class="o">(</span> PyAssembly <span class="o">(</span>50<span class="o">)</span> -&gt; PyAssembly <span class="o">(</span>50<span class="o">))</span> 23.182552504
</pre></div>
</div>
<p>Finally, the function <tt class="docutils literal"><span class="pre">plot_projectionwise_synapse_loss</span></tt> can be used to plot
the lost and realized synapses of one projection.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">plot_projectionwise_synapse_loss</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">marocco</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plots the realized and lost synapses of a projection</span>
<span class="sd">    params:</span>
<span class="sd">      proj    - a pyhmf.Projection</span>
<span class="sd">      marocco -  the PyMarocco object after the mapping has run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_weights</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">getWeights</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;array&#39;</span><span class="p">)</span>
    <span class="n">mapped_weights</span> <span class="o">=</span> <span class="n">marocco</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">getWeights</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
    <span class="n">realized_syns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mapped_weights</span><span class="p">))</span>
    <span class="n">lost_syns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">orig_weights</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mapped_weights</span><span class="p">))</span>

    <span class="n">conn_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">orig_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">conn_matrix</span><span class="p">[</span><span class="n">realized_syns</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1.</span>
    <span class="n">conn_matrix</span><span class="p">[</span><span class="n">lost_syns</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;Agg&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">conn_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">&#39;hot&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;post neuron&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;pre neuron&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;realized and lost synapses&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;synapse_loss.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure">
<img alt="Realized and Lost Synapses of a Projection" src="../_images/synapse_loss.png" />
<p class="caption">Figure 111: Realized (black) and lost (red) synapses of the stimulus projection in the
example network above.</p>
</div>
</div>
<div class="section" id="details-of-the-software-stack">
<span id="details-software-stack"></span><h2>Details of the software stack<a class="headerlink" href="#details-of-the-software-stack" title="Permalink to this headline">¶</a></h2>
<p>The BrainScaleS Wafer-Scale Software Stack is shown in Figure <a href="#waferscale-software-figure">112</a>.</p>
<p>User-provided neuronal network topologies  are evaluated by our <tt class="docutils literal"><span class="pre">PyNN</span></tt> API implementation (<tt class="docutils literal"><span class="pre">PyHMF</span></tt>),
which is written in C++ with a Python wrapper.
The data structures (spike trains, populations, projections, cell types, meta information, etc.) are implemented in C++ (<tt class="docutils literal"><span class="pre">euter</span></tt>).
This layer also provides a serialization and deserialization interface for lower software layers.
In a nutshell, <tt class="docutils literal"><span class="pre">euter</span></tt> serializes the <tt class="docutils literal"><span class="pre">PyNN</span></tt>/<tt class="docutils literal"><span class="pre">PyHMF</span></tt>-based experiment description into a binary data stream and hands over to the next software layer.
In the following software layers, the translation from this <cite>biological</cite> neuronal network description into a <cite>hardware</cite> configuration will be performed.
A large fraction of the translation work, in particular the network graph translation, is performed by the <tt class="docutils literal"><span class="pre">marocco</span></tt> mapping tool
(described in the <a class="reference external" href="http://www.kip.uni-heidelberg.de/Veroeffentlichungen/details.php?id=3052">PhD thesis of S. Jeltsch</a>.
Code documentation is provided by <tt class="docutils literal"><span class="pre">doxygen</span></tt> and available
<a class="reference external" href="https://brainscales-r.kip.uni-heidelberg.de:8443/view/doc/job/doc-dsl_marocco/marocco_Documentation">here</a>.</p>
<div class="figure" id="waferscale-software-figure">
<img alt="The BrainScaleS System Software Stack" src="../_images/software_as_pipeline.png" style="width: 100%;" />
<p class="caption">Figure 112: Data-flow-centric view of the user software stack of the BrainScaleS Wafer-Scale System.
[taken from <a class="reference external" href="http://www.kip.uni-heidelberg.de/Veroeffentlichungen/details.php?id=3112">PhD thesis of E. Müller</a>]</p>
</div>
<p><tt class="docutils literal"><span class="pre">marocco</span></tt> uses calibration (<tt class="docutils literal"><span class="pre">calibtic</span></tt>) and blacklisting (<tt class="docutils literal"><span class="pre">redman</span></tt>) information to take into account circuit-specific properties and defects.
This information is needed during the map &amp; route process to homogenize the behavior of hardware neuron and synapse circuits and to exclude defective parts of the system.</p>
</div>
</div>

            </div>

            <aside class="hbpdoc-hnav hbpdoc-hnav-bottom">
                
                <span class="hbpdoc-hnav-previous">
                    previous: <a class="hbpdoc-hnav-link" href="pm_hardware_configuration.html">About the BrainScaleS hardware</a>
                </span>
                
                
                <span class="hbpdoc-hnav-next">
                    next: <a class="hbpdoc-hnav-link" href="ess.html">Simulating the BrainScaleS hardware</a>
                </span>
                
            </aside>
        </article>
    </section>


    <div class="hbpdoc-footer">
        HBP Neuromorphic Computing Platform Guidebook <small>2017-02-14 13:33:55 (4aeed78)</small> 
    <div class="footer">
        &copy; Copyright 2015-2016, Andrew P. Davison, Eric Müller, Sebastian Schmitt, Bernhard Vogginger, David Lester, Thomas Pfeil, ....
      Last updated on Feb 14, 2017 (4aeed78, preliminary documentation).
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    </div>
</div>

  </body>
</html>